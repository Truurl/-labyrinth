#include "display.h"
#include "uart.h"
#include "conv.h"

const extern unsigned char labirynth [] = {
//first line
 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x3E, 0x00,
//second line
 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
 0x01, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01,
 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//third line
 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0xFF, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
//fourth line
 0x08, 0x08, 0x08, 0x08,
 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
 0x08, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04,
 0x04, 0x04, 0x04, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//fifth line
 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
 0x20, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x20, 0x20, 0x20,
 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//fifth line
 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00
};





void displayReset(void){
	HAL_GPIO_WritePin(RST_GPIO_Port, RST_Pin,GPIO_PIN_RESET);
  HAL_Delay(100);
	HAL_GPIO_WritePin(RST_GPIO_Port, RST_Pin,GPIO_PIN_SET);
}


void displayCmd(uint8_t cmd){
	//transmisja polecenia
	HAL_GPIO_WritePin(DC_GPIO_Port, DC_Pin, GPIO_PIN_RESET);
	//odblokowanei zegara
	HAL_GPIO_WritePin(CE_GPIO_Port, CE_Pin, GPIO_PIN_RESET);	
	//transmisja danych
	HAL_SPI_Transmit(&hspi3,&cmd,1,100);
	//blokada zegara
	HAL_GPIO_WritePin(CE_GPIO_Port, CE_Pin, GPIO_PIN_SET);
}

void displayWrite(uint8_t data){
	//wybï¿½r danych
	HAL_GPIO_WritePin(DC_GPIO_Port, DC_Pin, GPIO_PIN_SET);
	//odblokowanei zegara
	HAL_GPIO_WritePin(CE_GPIO_Port, CE_Pin, GPIO_PIN_RESET);
	//transmisja danych
	HAL_SPI_Transmit(&hspi3,&data,1,100);
	//blokada zegara
	HAL_GPIO_WritePin(CE_GPIO_Port, CE_Pin, GPIO_PIN_SET);
}

void displayInit(void){
	
	//reset resjtrow wyswietlacza
	displayReset();
	
  //przejscie w tryb polecen rozszerzonych
  // 0x21 - polecenie
  displayCmd(0x21);
 
  // Temperature Coefficient
  // 0x04 - polecenie | 0x0c - wartosc
  displayCmd(0x03);
	
	// Bias System
  // 0x10 - polecenie | 0x04 - wartosc (1/24)
	displayCmd(0x10 | 0x04);
 
	//ustawienie kontrastu
  // 0x80 - polecenie | 0x38 - wartosc
  displayCmd(0x80 | 0x38);
	
  //powrot do trybu polecen podstawowych
  displayCmd(0x20);
 
  // Ustawienie trybu pracy wytwietlacza - normalnego
	// 0x08 - polecenie | 0x04 - wartosc
  displayCmd(0x08 | 0x04);
	
	//czyszczenie ekrenu
  for(int i = 0; i < 504; i++){
     displayWrite(0x00);
	}
}


void displaySetCursor(uint8_t x, uint8_t y){
		if((x > 83 || y > 5)){return;}
		if((x < 0 || y < 0)){return;}
		//ustaweinie pozycji y
		displayCmd(0x40 | y);
		//ustawienie pozycji x
		displayCmd(0x80 | x);
		return;
}
void displayClear(void){
	displaySetCursor(0, 0);
	for(int i = 0; i < 504; i++){
	     displayWrite(0x00);
	}
	return;
}

void displayClearLine(uint8_t x, uint8_t y){
	if(x > 83 || y > 47) return;
	displaySetCursor(x,y);
	uint8_t col = 87 - x;
	for(uint8_t i = 0; i < col; ++i)
	{
		displayWrite(0x00);
	}
	displaySetCursor(x,y);
}

void displayPrint(char* sign){
		for(uint8_t i = 0; ;++i){
			int pos = ((int) sign[i] ) - 32;
			printInt(pos);
			if(sign[i] == '\0') break;

			displayWrite(font_ASCII[pos][0]);
			displayWrite(font_ASCII[pos][1]);
			displayWrite(font_ASCII[pos][2]);
			displayWrite(font_ASCII[pos][3]);
			displayWrite(font_ASCII[pos][4]);
		}
} 

void displayDrawPixel(uint8_t x, uint8_t y, uint8_t value){
	if(x > 83 || y > 47) return;
	uint8_t cursorY;
	//obliczanie rejstru Y
	cursorY = 5 - (y / 8);
	//ustawienie kursora w odpowiednim miejsu
	displaySetCursor(x,cursorY);
	//narysowanie pixela
	if( value == 1 ){ displayWrite((0x80 >> (y % 8))); }
	if( value == 0 ){ displayWrite((0x00)); }
}

void displayFloat(float number){
	char numb[] ={'0', '0', '0', '0', '0', '0'};
	if(number < 0) {number*=-1; displayPrint("-");}
	else{displayPrint(" ");}
	if(number >= 10){
			numb[0] = intToChar(( ((int)number) / 10 ) % 10 );
			numb[1] = intToChar(( ((int)number) % 10 ));
			numb[2] = '.';
			numb[3] = intToChar( ((int)(number * 10)) % 10 );
			numb[4] = intToChar( ((int)(number * 100)) % 10 );
			numb[5] = '\0';
			displayPrint(numb);
			return;
	}
	if(number <= 10){
			numb[0] = intToChar(( ((int)number) % 10 ));
			numb[1] = '.';
			numb[2] = intToChar( ((int)(number * 10)) % 10);
			numb[3] = intToChar(( ((int)(number * 100)) % 10));
			numb[4] = '\0';
			displayPrint(numb);
			return;
	}
}

void displayDrawLevel(void){
	displaySetCursor(0,0);
	for(uint16_t i = 0; i < 504; ++i){
		displayWrite(labirynth[i]);
	}
}

